<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
.label {
  fill: #777;
}

.yearlabel {
  font: 500 196px "Helvetica Neue";
  fill: #ddd;
}

.node-cluster {
  font: 10px sans-serif;
}

.link-cluster {
  stroke: steelblue;
  stroke-opacity: .4;
  fill: none;
}

.node-force {
  stroke: #000; 
  stroke-width: 1.5px;
}

.link-force {
  stroke: #999;
  stroke-opacity: .6;
}

.button {
  text-align: center;
  color: white;
  background: gray;
  border-color: black;
  border-style: solid;
  border-width: 1px;
  padding: 2px;
  width:350px;
  cursor: pointer;
  display: inline;
}  
#button {
  padding-left: 20px;
  padding-right: 20px;
}
#force, #cluster {
  float: right;
  width: 130px;
}
svg {
  width: 960px;
  height: 700px;
}
.nav {
  height: 22px;
  width: 962px;
  padding-top: 0;
  padding-bottom: 0;
}
div#view {
  width: 960px;
  height: 700px;
  border-color: #aaa;
  border-style: solid;
  border-width: 1px;
}
</style>
</head>
<body>
  <div class="nav">
     <div class="button" id="force">Force Layout</div>
     <div class="button" id="cluster">Cluster Layout</div>
     <div id="button" class="button"></div> 
     <div id="backward" class="button"> &lt;&lt; </div>
     <div id="play" class="button">play</div> 
     <div id="forward" class="button"> &gt;&gt; </div>
  </div>
  <div id="view"></div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

var config = {
  width: 960,
  height: 700,
  animationSpeed: 1500,
  layout: "force",  
  maxCount: 100
};

var app = { 
  minYear: null,
  maxYear: null,
  play: false,
  year: null,
  graph: null,
  counter: 0,
  linksTillYear: null,
  temp: null,
  svg: d3.select("#view").append("svg")
   .attr("width", config.width)
   .attr("height", config.height),
  force: d3.layout.force()
    .charge(-130)
    .linkDistance(30 + Math.random() * 70)
    .size([config.width, config.height]),
  cluster: d3.layout.cluster()
    .size([config.width, config.height]),
  layout: force,
    
  render: function () {
    this.svg.text(null);
    var graph = this.graph;
    
    // das ist das Textlabel f√ºr die Jahreszahl
    var label = this.svg.append("text")
	    .attr("class", "yearlabel")
	    .attr("text-anchor", "end")
	    .attr("y", config.height - 24)
	    .attr("x", config.width)
	    .text(this.year);
    
    this.counter=0;
    this.linksTillYear= graph.links.filter(function(a,b,c){ 
                                           a.source = a.from;
                                           a.target = a.to;
                                           return a.year < app.year; });
   if (config.layout === "force"){
	    this.force
		.nodes(graph.vertices)
		.links(this.linksTillYear)
		.start();
	    var link = this.svg.selectAll("line.link")
		  .data(this.linksTillYear);
		link.enter().append("line")
		  .attr("class", function(d) { app.counter++; return "link-force"; })
		  .style("stroke-width", function(link) { return link.count;});
		link.exit().remove();
	    var node = this.svg.selectAll("circle.node")
		  .data(graph.vertices);
		node.enter().append("circle")
                  .on("click", function(d) { 
                      console.log("circle clicked "+d.name);
                      var url = "/fosdem/coauthor.json?maxlen=" + config.maxCount +
                                "&start="+encodeURIComponent(d._id);
	              d3.json(url, function(graph) {
  			 app.minYear = app.year = +graph.minYear;
  			 app.maxYear = +graph.maxYear;
		         app.graph = graph;
                         app.render();
                      });
                   })
		  .attr("class", "node-force")
		  .attr("r", 5)
		  .style("fill", function(node) { if(graph.start.name === node.name) {
                                                     return "#ff0000";
                                                } else return "#00ff00"; })

		  .call(this.force.drag);
		node.exit().remove();

	    node.append("title")
		.text(function(d) { return d.name; });
	   
	    this.force.on("tick", function() {
	      link.attr("x1", function(d) { return d.source.x; })
		  .attr("y1", function(d) { return d.source.y; })
		  .attr("x2", function(d) { return d.target.x; })
		  .attr("y2", function(d) { return d.target.y; });

	      node.attr("cx", function(d) { return d.x; })
		  .attr("cy", function(d) { return d.y; });
	    });


    } else if (config.layout === "cluster"){
	var diameter = 700,
	    radius = diameter / 2,
	    innerRadius = radius - 120;

	var cluster = d3.layout.cluster()
	    .size([360, innerRadius ])
	    .sort(null)
	    .value(function(d) { return d.size; });

	var bundle = d3.layout.bundle();

	var line = d3.svg.line.radial()
	    .interpolate("bundle")
	    .tension(.85)
	    .radius(function(d) { return d.y; })
	    .angle(function(d) { return d.x / 180 * Math.PI; });
        var svg = this.svg;

        svg.attr("width", diameter);
        svg.attr("height", diameter);
 
        // re-assign svg to g element
        svg = svg
	  .append("g")
	    .attr("transform", "translate(" + radius + "," + radius + ")");


	var root = {
	  name: "",
	  children: [ ]
	}; 

	var nodes = { };
        var authors = graph;
	var index = 0;
	authors.vertices.forEach(function (author) {
	  var node = {
	    name: author.name,
	    parent: root,
	    key: author.name,
	    children: [ ],
	    size: Math.random() * 5000 // currently not used
	  };
	 
	  root.children.push(node);
	  nodes[index++] = node;
	});

	var edges = [ ];
	authors.links.forEach(function (link) {
          if(link.year < app.year) {
	    edges.push({ source: nodes[link.from], target: nodes[link.to] });
          }
	});

	var nodes = cluster.nodes(root), links = edges;

	  svg.selectAll(".link")
	      .data(bundle(links))
	    .enter().append("path")
	      .attr("class", "link-cluster")
	      .attr("d", line);

	  svg.selectAll(".node")
	      .data(nodes.filter(function(n) { return true;  }))
	    .enter().append("g")
	      .attr("class", "node-cluster")
	      .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })
	    .append("text")
	      .attr("dx", function(d) { return d.x < 180 ? 8 : -8; })
	      .attr("dy", ".31em")
	      .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
	      .attr("transform", function(d) { return (d.x < 180 ? null : "rotate(180)"); })
	      .text(function(d) { return d.key; });

//	d3.select(self.frameElement).style("height", diameter + "px");
  } 
     $("div#button").text(app.graph.start.name + " " + app.counter + " cumulated connections until " + (this.year) + " ("+this.minYear+"-"+this.maxYear+")");
  }
};

$(document).ready(function(){
 $("div#button, div#forward").click(function(event) {
     app.play = false;
     $("div#play:contains('pause')").text("play");
     app.year++;
     if(app.year > app.maxYear) app.year=app.minYear;
     app.render();
 });
 $("div#play").click(function(event) {
     if(app.play === false) {
        app.play = true;
        $(this).text("pause");
        app.year=app.minYear+1;
        app.render();
        app.year++;
	function myLoop () { 
	   setTimeout(function () { 
	      app.render();
	      app.year++;        
	      if (app.play && app.year <= app.maxYear) {
		 myLoop();  
	      }     
	   }, config.animationSpeed)
	}
        myLoop();
    } else {
      app.play = false;
      $(this).text("play");
    }
 });
 $("div#backward").click(function(event) {
     app.play = false;
     $("div#play:contains('pause')").text("play");
     app.year = app.minYear;
     app.render();
 });
 $("#cluster").click(function(event) {
     config.layout = "cluster";
     app.render();
 });
 $("#force").click(function(event) {
     config.layout = "force";
     app.render();
 }); 
});
    
d3.json("/fosdem/coauthor.json?maxlen=" + config.maxCount, function(graph) {
  app.minYear = app.year = +graph.minYear;
  app.maxYear = +graph.maxYear;
  app.graph = graph;
  app.render();
});

</script>
</body>
</html>
